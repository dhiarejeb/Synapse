<div class="board-container"
     (mousedown)="onBoardMouseDown($event)"
     (mousemove)="onBoardMouseMove($event)"
     (mouseup)="onBoardMouseUp()"
     (mouseleave)="onBoardMouseUp()"
     (click)="deselectAll()">

  <!-- Wooden Frame -->
  <div class="board-frame">
    <div class="board-surface" [class.panning]="isPanning">

      <!-- ===================== TOOLBAR ===================== -->
      <div class="toolbar" (click)="$event.stopPropagation()">
        <div class="toolbar-inner">
          <div class="toolbar-group">
            <label class="toolbar-label">Type:</label>
            <select [(ngModel)]="newNoteType" class="toolbar-select">
              <option *ngFor="let type of NOTE_TYPES" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>

          <div class="toolbar-group" *ngIf="newNoteType === 'sticky'">
            <label class="toolbar-label">Color:</label>
            <div class="color-picker">
              <button *ngFor="let color of STICKY_COLORS"
                      class="color-btn"
                      [class]="color.class"
                      [class.active]="newNoteColor === color.value"
                      (click)="newNoteColor = color.value"
                      [title]="color.label">
              </button>
            </div>
          </div>

          <button class="toolbar-btn add-btn" (click)="createNote()">
            <span class="btn-icon">+</span>
            Add {{ newNoteType === 'sticky' ? 'Note' : newNoteType === 'photo' ? 'Photo' : newNoteType === 'document' ? 'Document' : 'Clipping' }}
          </button>

          <div class="toolbar-divider"></div>

          <button class="toolbar-btn link-btn"
                  [class.active]="linkMode"
                  (click)="toggleLinkMode()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            {{ linkMode ? 'Cancel' : 'Connect' }}
          </button>

          <span class="toolbar-hint" *ngIf="linkMode && !linkFromNoteId">
            Click first card...
          </span>
          <span class="toolbar-hint" *ngIf="linkMode && linkFromNoteId">
            Click second card...
          </span>
        </div>
      </div>

      <!-- ===================== NOTES WRAPPER ===================== -->
      <div class="notes-wrapper"
           [style.transform]="'translate(' + panOffset.x + 'px, ' + panOffset.y + 'px)'">

        <!-- ===================== STRING CONNECTIONS ===================== -->
        <svg class="links-svg"
             [style.transform]="'translate(' + (-panOffset.x) + 'px, ' + (-panOffset.y) + 'px)'"
             [style.width.px]="3000"
             [style.height.px]="3000">
          <defs>
            <!-- Pin markers for string ends -->
            <filter id="pin-shadow" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.3"/>
            </filter>
          </defs>

          <g *ngFor="let link of links; trackBy: trackByLinkId" class="link-group">
            <!-- String path with curve -->
            <path [attr.d]="getLinkPath(link)"
                  class="link-string"
                  fill="none"
                  stroke="#8B0000"
                  stroke-width="2"
                  (click)="deleteLinkById(link.id!, $event)">
            </path>

            <!-- Pin at start -->
            <circle [attr.cx]="getNoteCenterX(link.fromNoteId)"
                    [attr.cy]="getNoteCenterY(link.fromNoteId)"
                    r="6"
                    class="pin-head"
                    fill="#C41E3A"
                    filter="url(#pin-shadow)"/>
            <circle [attr.cx]="getNoteCenterX(link.fromNoteId)"
                    [attr.cy]="getNoteCenterY(link.fromNoteId)"
                    r="2"
                    fill="#FFB6C1"
                    class="pin-highlight"/>

            <!-- Pin at end -->
            <circle [attr.cx]="getNoteCenterX(link.toNoteId)"
                    [attr.cy]="getNoteCenterY(link.toNoteId)"
                    r="6"
                    class="pin-head"
                    fill="#C41E3A"
                    filter="url(#pin-shadow)"/>
            <circle [attr.cx]="getNoteCenterX(link.toNoteId)"
                    [attr.cy]="getNoteCenterY(link.toNoteId)"
                    r="2"
                    fill="#FFB6C1"
                    class="pin-highlight"/>
          </g>
        </svg>

        <!-- ===================== NOTES/CARDS ===================== -->
        <ng-container *ngFor="let note of notes; trackBy: trackByNoteId">

          <!-- STICKY NOTE -->
          <div *ngIf="note.noteType === 'sticky' || !note.noteType"
               class="card sticky-note"
               [class]="getStickyColorClass(note.color || 'yellow')"
               [class.selected]="selectedNoteId === note.id"
               [class.link-source]="linkFromNoteId === note.id"
               [class.link-mode]="linkMode"
               [ngStyle]="{
                 'left.px': note.positionX,
                 'top.px': note.positionY,
                 'z-index': note.zIndex,
                 'transform': 'rotate(' + (note.rotation || 0) + 'deg)'
               }"
               cdkDrag
               [cdkDragFreeDragPosition]="{x: note.positionX || 0, y: note.positionY || 0}"
               (cdkDragStarted)="onDragStarted(note)"
               (cdkDragEnded)="dragEnded($event, note)"
               (click)="selectNote(note, $event)"
               (dblclick)="startEditing(note, $event)">

            <!-- Push Pin -->
            <div class="push-pin">
              <div class="pin-head"></div>
              <div class="pin-point"></div>
            </div>

            <!-- Content -->
            <div class="card-content">
              <textarea *ngIf="editingNoteId === note.id"
                        [(ngModel)]="note.content"
                        (blur)="stopEditing(note)"
                        (click)="$event.stopPropagation()"
                        class="note-textarea"
                        placeholder="Write something..."
                        autofocus></textarea>
              <p *ngIf="editingNoteId !== note.id" class="note-text">
                {{ note.content || 'Double-click to edit...' }}
              </p>

              <img *ngIf="note.imageUrl" [src]="note.imageUrl" alt="Note image" class="note-image" />
            </div>

            <!-- Actions (visible when selected) -->
            <div class="card-actions" *ngIf="selectedNoteId === note.id && !linkMode">
              <button class="action-btn upload-btn" (click)="triggerFileInput(note.id!); $event.stopPropagation()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </button>
              <button class="action-btn delete-btn" (click)="deleteNote(note.id!, $event)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
              <input type="file"
                     [id]="'file-input-' + note.id"
                     (change)="uploadNoteImage($event, note.id!)"
                     accept="image/*"
                     style="display: none" />
            </div>
          </div>

          <!-- PHOTO CARD (Polaroid style) -->
          <div *ngIf="note.noteType === 'photo'"
               class="card photo-card"
               [class.selected]="selectedNoteId === note.id"
               [class.link-source]="linkFromNoteId === note.id"
               [class.link-mode]="linkMode"
               [ngStyle]="{
                 'left.px': note.positionX,
                 'top.px': note.positionY,
                 'z-index': note.zIndex,
                 'transform': 'rotate(' + (note.rotation || 0) + 'deg)'
               }"
               cdkDrag
               [cdkDragFreeDragPosition]="{x: note.positionX || 0, y: note.positionY || 0}"
               (cdkDragStarted)="onDragStarted(note)"
               (cdkDragEnded)="dragEnded($event, note)"
               (click)="selectNote(note, $event)"
               (dblclick)="startEditing(note, $event)">

            <div class="push-pin">
              <div class="pin-head"></div>
              <div class="pin-point"></div>
            </div>

            <div class="photo-frame">
              <div class="photo-area" *ngIf="!note.imageUrl" (click)="triggerFileInput(note.id!); $event.stopPropagation()">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Click to add photo</span>
              </div>
              <img *ngIf="note.imageUrl" [src]="note.imageUrl" alt="Photo" class="photo-image" />
            </div>

            <div class="photo-caption">
              <textarea *ngIf="editingNoteId === note.id"
                        [(ngModel)]="note.content"
                        (blur)="stopEditing(note)"
                        (click)="$event.stopPropagation()"
                        class="caption-textarea"
                        placeholder="Add caption..."
                        autofocus></textarea>
              <p *ngIf="editingNoteId !== note.id" class="caption-text">
                {{ note.content || 'Add caption...' }}
              </p>
            </div>

            <div class="card-actions" *ngIf="selectedNoteId === note.id && !linkMode">
              <button class="action-btn upload-btn" (click)="triggerFileInput(note.id!); $event.stopPropagation()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </button>
              <button class="action-btn delete-btn" (click)="deleteNote(note.id!, $event)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
              <input type="file"
                     [id]="'file-input-' + note.id"
                     (change)="uploadNoteImage($event, note.id!)"
                     accept="image/*"
                     style="display: none" />
            </div>
          </div>

          <!-- DOCUMENT CARD -->
          <div *ngIf="note.noteType === 'document'"
               class="card document-card"
               [class.selected]="selectedNoteId === note.id"
               [class.link-source]="linkFromNoteId === note.id"
               [class.link-mode]="linkMode"
               [ngStyle]="{
                 'left.px': note.positionX,
                 'top.px': note.positionY,
                 'z-index': note.zIndex,
                 'transform': 'rotate(' + (note.rotation || 0) + 'deg)'
               }"
               cdkDrag
               [cdkDragFreeDragPosition]="{x: note.positionX || 0, y: note.positionY || 0}"
               (cdkDragStarted)="onDragStarted(note)"
               (cdkDragEnded)="dragEnded($event, note)"
               (click)="selectNote(note, $event)"
               (dblclick)="startEditing(note, $event)">

            <div class="push-pin">
              <div class="pin-head"></div>
              <div class="pin-point"></div>
            </div>

            <div class="document-content">
              <div class="document-lines"></div>
              <div class="document-margin"></div>
              <textarea *ngIf="editingNoteId === note.id"
                        [(ngModel)]="note.content"
                        (blur)="stopEditing(note)"
                        (click)="$event.stopPropagation()"
                        class="document-textarea"
                        placeholder="Type document content..."
                        autofocus></textarea>
              <p *ngIf="editingNoteId !== note.id" class="document-text">
                {{ note.content || 'Double-click to add content...' }}
              </p>
            </div>

            <div class="card-actions" *ngIf="selectedNoteId === note.id && !linkMode">
              <button class="action-btn delete-btn" (click)="deleteNote(note.id!, $event)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- CLIPPING CARD (Newspaper style) -->
          <div *ngIf="note.noteType === 'clipping'"
               class="card clipping-card"
               [class.selected]="selectedNoteId === note.id"
               [class.link-source]="linkFromNoteId === note.id"
               [class.link-mode]="linkMode"
               [ngStyle]="{
                 'left.px': note.positionX,
                 'top.px': note.positionY,
                 'z-index': note.zIndex,
                 'transform': 'rotate(' + (note.rotation || 0) + 'deg)'
               }"
               cdkDrag
               [cdkDragFreeDragPosition]="{x: note.positionX || 0, y: note.positionY || 0}"
               (cdkDragStarted)="onDragStarted(note)"
               (cdkDragEnded)="dragEnded($event, note)"
               (click)="selectNote(note, $event)"
               (dblclick)="startEditing(note, $event)">

            <div class="push-pin">
              <div class="pin-head"></div>
              <div class="pin-point"></div>
            </div>

            <div class="clipping-content">
              <div class="clipping-header">EVIDENCE</div>
              <textarea *ngIf="editingNoteId === note.id"
                        [(ngModel)]="note.content"
                        (blur)="stopEditing(note)"
                        (click)="$event.stopPropagation()"
                        class="clipping-textarea"
                        placeholder="Clipping content..."
                        autofocus></textarea>
              <p *ngIf="editingNoteId !== note.id" class="clipping-text">
                {{ note.content || 'Double-click to add content...' }}
              </p>

              <img *ngIf="note.imageUrl" [src]="note.imageUrl" alt="Clipping image" class="clipping-image" />
            </div>

            <div class="card-actions" *ngIf="selectedNoteId === note.id && !linkMode">
              <button class="action-btn upload-btn" (click)="triggerFileInput(note.id!); $event.stopPropagation()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </button>
              <button class="action-btn delete-btn" (click)="deleteNote(note.id!, $event)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
              <input type="file"
                     [id]="'file-input-' + note.id"
                     (change)="uploadNoteImage($event, note.id!)"
                     accept="image/*"
                     style="display: none" />
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Pan hint -->
      <div class="pan-hint">
        Hold <kbd>Shift</kbd> + Drag to pan
      </div>
    </div>
  </div>
</div>
